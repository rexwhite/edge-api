# This playbook is meant to be an all-in-one
- name: Run the ostree update in a single play without external deps
  become: true
  hosts: localhost
  vars:
    fleet_infra_env: "@@ .FleetInfraEnv @@"
    update_number: "@@ .UpdateNumber @@"
    s3_region: "@@ .BucketRegion @@"
    s3_buckets:
      prod: "rh-edge-tarballs-prod"
      stage: "rh-edge-tarballs-stage"
      perf: "rh-edge-tarballs-perf"
    repo_url: "https://{{ s3_buckets[fleet_infra_env] | default('rh-edge-tarballs-prod') }}.s3.{{ s3_region | default('us-east-1') }}.amazonaws.com/{{ update_number }}/upd/{{ update_number }}/repo"
    ostree_remote_name: "@@ .GoTemplateRemoteName @@"
    ostree_changes_refs: "@@ .RemoteOstreeUpdate @@"
    os_tree_ref: "@@ .OSTreeRef @@"
    ostree_gpg_verify: "false"
    ostree_gpg_keypath: "/etc/pki/rpm-gpg/"
    ostree_remote_template: |
      [remote "{{ ostree_remote_name }}"]
      url={{ repo_url }}
      gpg-verify={{ ostree_gpg_verify }}
      gpgkeypath={{ ostree_gpg_keypath }}
      contenturl={{ repo_url }}
    insights_signature_exclude: "/vars/insights_signature,/vars/fleet_infra_env,/vars/update_number,/vars/s3_region,/vars/ostree_remote_name"
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldYTm9kVXR6ZG5jMU9FUXJhalZ3VGtGUmFYZHVVa0ZCYlZGWE4w
      MTZWMEZYWm1kUWEzTndOV0ptTmxwWFpsSjZlVlpaUkVGd2JVZ0tXSHBqVnlzNU56Sk1WemR2VFV4
      MFJYUkJSWFpsUjJ4UFlqSnZkamx4Wkd4eGEyMU5RbE5CY3k5SFNFY3JSWHBMVDBGNGQwRTRSMnA2
      V2pobVUxcEhNUXBITVhGWlNGcFJkVGhLU1ZrNGVGTnBOMDVhT0Vod2NHOXpLMVJDYlN0bldrUnZR
      M0JwZDJWbVdVUjRhVEJJTVVaTVJscDNkMEUwVEVwalIwZFJVbGhRQ2pJeE9USkpRelY1Y1VaaWEw
      dHFkMkZFY1ZCTmFYUjZNbEZtT1dkWlFrMXNWelYwWW1KaE9FaHVLMjlVYkRGVFkyOTNlbFZJYkdw
      Q2EzTnpabnB1TUdzS2FGbFNhRTVYWW01UVl6WktWR1JXWlZGRWNWVlNTMng2WlM4d1RXaEhkbFpH
      VDA1c2JVNDVkVXRSVlZobllYTjRkRTFDYTBGUVJGSTFOVkF6VlRCVVNRcG5aVGxIZUUxd1owaHNZ
      WHBzU1RsNFpIRTRjVWhqVDFwVFZVVlVOakpOUmxaclVIRjVOREJvZDJveGRtSnlTM1k1Y1doTWMx
      Y3ZXV0p2T1ZNM1RVdHJDbU5EVXpSSU5UTlVWVVZRZWpjMlNYaGhiVmxvWm5KUlptWjNjbUZQZEd4
      bVYwbFZTVU5GT1VwT01IZGpjSE5sZUdoNmF6WjVkR1V3WVRWR2JIQkNTbmtLSzJKc1ZtazVkMU5C
      V0V0V1l6UXZOa2x1TXpaQ0szaEtTbEp1YkZwVVYwUllZVkl3VFRWS1MxZG5ja2haU21VelduZHJZ
      akJhYXpFeVdXUkdaMU56TVFwaFRFWnVaVlZ0Tm5aYVoyZFNNVWRMYkUxSFptbFZTR1V4Um5CU09V
      MVdaMVJNZFVZNFJXMDRRWFZFVjI0eVZXTTNlazlSYWxOR1lVSlRUakYwYmxSSkNtbEJNVmszTTJS
      WFZYVnlVbFEwVm5kYVNWbExVa2MyTlhnNE0zaDRVa1JDYTBaclJFMHhXazlPUlZSeGMwRnpZa2hW
      VkZaMldteDNWMjFpY0ZGRFdra0tTME5VV25GaWFsUlhMMmhVVGtOa2RrcEJSMEl5U2xVNFJHRlpR
      MmxyV0dzMlMwbEVPR05HYUZWQ2JXVTFSa2RDWnpaQldXNHZjbVF6Y2taNFRVSXhjZ3BCU2xKUWRu
      VmFOWFZSYXowS1BUSlRaa1FLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: apply templated ostree remote config
      ansible.builtin.copy:
        content: "{{ ostree_remote_template }}"
        dest: /etc/ostree/remotes.d/rhel-edge.conf
    - name: run rpmostree update
      when: ostree_changes_refs=="false"
      ansible.builtin.shell: rpm-ostree upgrade --allow-downgrade
      register: rpmostree_upgrade_out
      changed_when: '"No upgrade available" not in rpmostree_upgrade_out.stdout'
      failed_when: 'rpmostree_upgrade_out.rc != 0'
    - name: run rpmostree rebase
      when: ostree_changes_refs=="true"
      ansible.builtin.shell: rpm-ostree rebase "{{ os_tree_ref }}"
      register: rpmostree_upgrade_out
      changed_when: '"No upgrade available" not in rpmostree_upgrade_out.stdout'
      failed_when: 'rpmostree_upgrade_out.rc != 0'
    - name: schedule reboot when rpmostree upgraded
      ansible.builtin.shell: systemd-run --on-active=5 /usr/bin/systemctl reboot
      when: '"Staging deployment...done" in rpmostree_upgrade_out.stdout'
